# 智能匹配算法优化功能使用说明

## 快速开始

### 1. 初始化匹配规则

在 Navicat 中执行 `matching_rules_init.sql` 脚本：

```sql
-- 该脚本会创建 matching_rules 表并初始化默认规则
-- 包括：
-- - 8条排除规则（孕妇、过敏、肿瘤等）
-- - 5条优先规则（依从性好、有经验等）
```

### 2. 验证规则是否生效

```sql
-- 查看所有规则
SELECT * FROM matching_rules WHERE is_active = TRUE ORDER BY rule_type, priority DESC;

-- 查看规则统计
SELECT 
    rule_type AS '规则类型',
    COUNT(*) AS '规则数量'
FROM matching_rules
WHERE is_active = TRUE
GROUP BY rule_type;
```

### 3. 重启应用

重启 Spring Boot 应用，新的匹配算法会自动生效。

---

## 主要改进

### ✅ 自动排除不符合条件的受试者

**示例**：
- 试验要求：高血压患者，40-65岁
- 受试者A：45岁，高血压，健康状况良好 → ✅ 匹配分数 94
- 受试者B：50岁，高血压，**孕妇** → ❌ 自动排除，分数 0
- 受试者C：48岁，高血压，**近期参加过其他试验** → ❌ 自动排除，分数 0

### ✅ 优先推荐最合适的受试者

**示例**：
- 受试者A：符合条件，**依从性好，有试验经验** → 额外加 9 分
- 受试者B：符合条件，普通受试者 → 无额外加分
- 结果：受试者A 排名更靠前

### ✅ 近义词智能识别

**示例**：
- 试验要求：高血压
- 受试者描述："血压高，服用降压药" → ✅ 识别为高血压（近义词匹配）
- 受试者描述："原发性高血压病" → ✅ 识别为高血压（近义词匹配）

---

## 自定义配置

### 添加新的排除规则

```sql
-- 例如：排除有心脏起搏器的受试者
INSERT INTO matching_rules (rule_type, keywords, description, priority, weight_score, is_active, created_at)
VALUES ('EXCLUSION', '心脏起搏器,起搏器植入', '排除有心脏起搏器的受试者', 90, NULL, TRUE, NOW());
```

### 添加新的优先规则

```sql
-- 例如：优先推荐有医学背景的受试者
INSERT INTO matching_rules (rule_type, keywords, description, priority, weight_score, is_active, created_at)
VALUES ('PRIORITY', '医学背景,医护人员,医学知识', '优先推荐有医学背景的受试者', 65, 4, TRUE, NOW());
```

### 调整规则权重

```sql
-- 提高"依从性好"的加分
UPDATE matching_rules 
SET weight_score = 8 
WHERE keywords LIKE '%依从性好%';

-- 降低"本地受试者"的加分
UPDATE matching_rules 
SET weight_score = 2 
WHERE keywords LIKE '%本地%';
```

### 禁用某个规则

```sql
-- 临时禁用"近期参加试验"的排除规则
UPDATE matching_rules 
SET is_active = FALSE 
WHERE keywords LIKE '%近期参加试验%';
```

---

## 常见问题

### Q1: 如何查看某个受试者被排除的原因？

A: 在匹配结果的"匹配说明"列中会显示：
- "命中排除条件，不符合入组要求"
- "年龄不符合要求"
- "性别不符合要求"

### Q2: 如何调整推荐阈值？

A: 目前默认阈值为 60 分。如需调整，需要在代码中修改 `MatchingConfig` 的 `recommendThreshold` 参数。

### Q3: 近义词字典如何扩展？

A: 在 `TextNormalizer.java` 的 `SYNONYM_MAP` 中添加新的近义词映射。

### Q4: 规则的优先级有什么用？

A: 优先级用于规则执行顺序，数值越大越先执行。对于排除规则，高优先级的规则会先被检查。

---

## 技术支持

如有问题，请查看：
- `智能匹配算法设计文档.md` - 原始算法设计
- `智能匹配算法优化方案.md` - 详细优化方案
- 源代码：`MatchingServiceImpl.java`、`TextNormalizer.java`

---

**版本**：v2.0  
**更新日期**：2026年1月13日
