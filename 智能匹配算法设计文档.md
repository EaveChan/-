# 临床试验受试者智能匹配算法设计文档

## 1. 概述

本文档详细描述了临床试验受试者智能匹配系统的核心算法设计与实现。该算法旨在自动化地为临床试验筛选和推荐最合适的受试者，提高招募效率和匹配准确度。

### 1.1 算法目标

- **自动化筛选**：根据临床试验的入组标准，自动筛选符合条件的受试者
- **智能评分**：为每个受试者计算匹配分数（0-100分），量化匹配程度
- **优先级排序**：按匹配分数降序排列，优先推荐最合适的受试者
- **可解释性**：为每个匹配结果提供清晰的说明，便于研究人员理解和决策

### 1.2 技术实现

- **编程语言**：Java
- **框架**：Spring Boot
- **核心类**：`MatchingServiceImpl`
- **算法类型**：基于规则的多维度评分算法

---

## 2. 算法架构

### 2.1 核心方法

```
calculateMatchingScore(User subject, ClinicalTrial trial) → int
```

该方法是算法的核心，负责计算单个受试者与临床试验的匹配分数。

### 2.2 辅助方法

| 方法名 | 功能 | 返回值范围 |
|--------|------|-----------|
| `calculateAgeScore()` | 计算年龄优先级分数 | 0-20分 |
| `calculateHealthMatchScore()` | 计算健康状况匹配分数 | 0-20分 |
| `normalizeGender()` | 标准化性别值 | MALE/FEMALE |
| `generateMatchingExplanation()` | 生成匹配说明 | 文本描述 |
| `batchCalculateMatching()` | 批量计算并排序 | 匹配结果列表 |

---

## 3. 匹配评分算法详解

### 3.1 评分体系（总分100分）

匹配分数由以下几个维度组成：

| 维度 | 分值 | 说明 |
|------|------|------|
| **硬性条件** | 0分（不通过） | 年龄、性别必须符合要求 |
| **基础分** | 60分 | 满足所有硬性条件后的基础分 |
| **年龄优先级** | 0-20分 | 年龄越接近理想值，分数越高 |
| **健康状况匹配** | 0-20分 | 健康状况与试验要求的匹配度 |

### 3.2 硬性条件筛选（一票否决）

#### 3.2.1 年龄范围检查

```java
if (subject.getAge() < trial.getAgeMin() || subject.getAge() > trial.getAgeMax()) {
    return 0; // 年龄不符合，直接淘汰
}
```

**规则**：
- 受试者年龄必须在 `[ageMin, ageMax]` 范围内
- 不符合条件的受试者直接得0分，不再进行后续评分

**示例**：
- 试验要求：40-65岁
- 受试者A：45岁 → ✅ 通过
- 受试者B：38岁 → ❌ 淘汰（得0分）
- 受试者C：70岁 → ❌ 淘汰（得0分）

#### 3.2.2 性别要求检查

```java
if (genderReq != null && !genderReq.equalsIgnoreCase("ANY") && !genderReq.equalsIgnoreCase("不限")) {
    if (!normalizeGender(subject.getGender()).equals(normalizeGender(genderReq))) {
        return 0; // 性别不符合，直接淘汰
    }
}
```

**规则**：
- 如果试验有性别要求（非"ANY"或"不限"），受试者性别必须匹配
- 支持中英文性别值：M/男/MALE → MALE，F/女/FEMALE → FEMALE
- 不符合条件的受试者直接得0分

**示例**：
- 试验要求：仅限女性
- 受试者A：女 → ✅ 通过
- 受试者B：男 → ❌ 淘汰（得0分）

---

### 3.3 基础分（60分）

通过所有硬性条件检查的受试者，自动获得60分基础分。

**设计理念**：
- 60分表示"基本合格"
- 确保所有通过筛选的受试者都有一个合理的起始分数
- 为后续的优化评分提供基础

---

### 3.4 年龄优先级评分（0-20分）

#### 3.4.1 算法原理

年龄优先级评分基于"年龄越接近范围中值，匹配度越高"的原则。

#### 3.4.2 计算公式

```
midAge = (ageMin + ageMax) / 2          // 年龄范围中值
ageRange = ageMax - ageMin              // 年龄范围跨度
ageDiff = |age - midAge|                // 受试者年龄与中值的差距
ratio = 1.0 - (ageDiff / ageRange)      // 匹配比例
ageScore = 20 × max(0, ratio)           // 年龄分数
```

#### 3.4.3 评分示例

**场景**：试验要求年龄 40-65岁

| 受试者年龄 | 中值 | 差距 | 范围 | 比例 | 年龄分数 |
|-----------|------|------|------|------|---------|
| 52岁 | 52.5 | 0.5 | 25 | 0.98 | 19.6分 ≈ 20分 |
| 45岁 | 52.5 | 7.5 | 25 | 0.70 | 14分 |
| 40岁 | 52.5 | 12.5 | 25 | 0.50 | 10分 |
| 60岁 | 52.5 | 7.5 | 25 | 0.70 | 14分 |
| 65岁 | 52.5 | 12.5 | 25 | 0.50 | 10分 |

#### 3.4.4 设计优势

- **公平性**：年龄范围两端的受试者得分相同
- **梯度性**：分数随年龄差距平滑变化
- **适应性**：自动适应不同的年龄范围跨度

---

### 3.5 健康状况匹配评分（0-20分）

#### 3.5.1 算法原理

使用关键词匹配算法，评估受试者健康状况与试验要求的匹配程度。

#### 3.5.2 计算流程

```java
// 1. 提取试验要求中的关键词（支持多种分隔符）
String[] keywords = trialRequirement.toLowerCase().split("[,，、\\s]+");

// 2. 在受试者健康状况中查找关键词
int matchCount = 0;
for (String keyword : keywords) {
    if (subjectHealth.contains(keyword)) {
        matchCount++;
    }
}

// 3. 计算匹配分数
healthScore = 20 × (matchCount / keywords.length)
```

#### 3.5.3 特殊情况处理

| 情况 | 处理方式 | 分数 |
|------|---------|------|
| 试验无健康要求 | 给予满分 | 20分 |
| 受试者未填写健康状况 | 给予基础分 | 10分 |
| 完全匹配 | 所有关键词都匹配 | 20分 |
| 部分匹配 | 按比例计算 | 0-20分 |
| 完全不匹配 | 无关键词匹配 | 0分 |

#### 3.5.4 评分示例

**场景1：高血压药物试验**

- 试验要求：`"高血压,血压控制"`
- 关键词：["高血压", "血压控制"]

| 受试者健康状况 | 匹配关键词 | 匹配数 | 健康分数 |
|---------------|-----------|--------|---------|
| "高血压，血压控制良好" | 高血压、血压控制 | 2/2 | 20分 |
| "高血压患者，服用降压药" | 高血压 | 1/2 | 10分 |
| "身体健康，无慢性疾病" | 无 | 0/2 | 0分 |

**场景2：健康志愿者试验**

- 试验要求：`"健康,无慢性疾病"`
- 关键词：["健康", "无慢性疾病"]

| 受试者健康状况 | 匹配关键词 | 匹配数 | 健康分数 |
|---------------|-----------|--------|---------|
| "身体健康，无慢性疾病" | 健康、无慢性疾病 | 2/2 | 20分 |
| "健康志愿者，定期运动" | 健康 | 1/2 | 10分 |
| "高血压，糖尿病" | 无 | 0/2 | 0分 |

---

## 4. 匹配等级划分

### 4.1 分数区间与等级

| 分数区间 | 匹配等级 | 推荐建议 | 说明文本 |
|---------|---------|---------|---------|
| 90-100分 | 优秀匹配 | 强烈推荐 | "高度匹配，强烈推荐" |
| 75-89分 | 良好匹配 | 推荐 | "匹配度良好，推荐" |
| 60-74分 | 基本匹配 | 可考虑 | "基本匹配，可考虑" |
| 1-59分 | 匹配度低 | 不推荐 | "匹配度较低" |
| 0分 | 不匹配 | 淘汰 | 具体原因（年龄/性别不符） |

### 4.2 UI展示

在用户界面中，使用不同颜色标识匹配等级：

- **绿色徽章**：80分以上（高度匹配）
- **黄色徽章**：60-79分（中等匹配）
- **灰色徽章**：60分以下（匹配度较低）

---

## 5. 批量匹配与排序

### 5.1 批量处理流程

```java
public List<MatchingResult> batchCalculateMatching(List<User> subjects, ClinicalTrial trial) {
    List<MatchingResult> results = new ArrayList<>();
    
    // 1. 遍历所有受试者
    for (User subject : subjects) {
        // 2. 只处理状态为活跃的受试者
        if (!subject.isStatus()) {
            continue;
        }
        
        // 3. 计算匹配分数
        int score = calculateMatchingScore(subject, trial);
        
        // 4. 生成匹配说明
        String explanation = generateMatchingExplanation(subject, trial, score);
        
        // 5. 创建匹配结果对象
        MatchingResult result = new MatchingResult(subject, score, explanation);
        results.add(result);
    }
    
    // 6. 按匹配分数降序排序
    results.sort(Comparator.comparingInt(MatchingResult::getMatchingScore).reversed());
    
    return results;
}
```

### 5.2 排序规则

- **主排序**：按匹配分数降序（分数高的在前）
- **目的**：优先展示最合适的受试者
- **实现**：使用Java Stream API的Comparator

---

## 6. 算法优势与特点

### 6.1 核心优势

1. **多维度评估**
   - 综合考虑年龄、性别、健康状况等多个维度
   - 避免单一标准的片面性

2. **量化评分**
   - 0-100分的标准化评分体系
   - 便于比较和排序

3. **可解释性强**
   - 每个匹配结果都有清晰的说明
   - 研究人员可以理解评分依据

4. **灵活性高**
   - 支持不同类型的临床试验
   - 可根据需求调整评分权重

5. **性能优化**
   - 批量处理提高效率
   - 一次性完成所有受试者的评分

### 6.2 算法特点

- **硬性条件优先**：不符合基本要求的受试者直接淘汰
- **梯度评分**：符合条件的受试者根据匹配程度获得不同分数
- **关键词匹配**：使用自然语言处理技术匹配健康状况
- **自动排序**：按分数降序排列，优先推荐最佳人选

---

## 7. 实际应用场景

### 7.1 场景1：高血压药物临床试验

**试验要求**：
- 年龄：40-65岁
- 性别：不限
- 健康要求：高血压，血压控制

**匹配结果**：

| 受试者 | 年龄 | 性别 | 健康状况 | 基础分 | 年龄分 | 健康分 | 总分 | 等级 |
|-------|------|------|---------|-------|-------|-------|------|------|
| 张三 | 45岁 | 男 | 高血压，血压控制良好 | 60 | 14 | 20 | 94 | 优秀 |
| 周八 | 55岁 | 男 | 高血压和2型糖尿病 | 60 | 18 | 10 | 88 | 优秀 |
| 刘十二 | 58岁 | 女 | 高血脂，胆固醇偏高 | 60 | 16 | 0 | 76 | 良好 |
| 王五 | 38岁 | 男 | 身体健康，无慢性疾病 | 0 | - | - | 0 | 淘汰 |

### 7.2 场景2：健康志愿者试验

**试验要求**：
- 年龄：18-45岁
- 性别：不限
- 健康要求：身体健康，无慢性疾病

**匹配结果**：

| 受试者 | 年龄 | 性别 | 健康状况 | 基础分 | 年龄分 | 健康分 | 总分 | 等级 |
|-------|------|------|---------|-------|-------|-------|------|------|
| 孙七 | 28岁 | 男 | 身体健康，定期运动 | 60 | 18 | 20 | 98 | 优秀 |
| 何十七 | 29岁 | 女 | 身体健康，规律作息 | 60 | 17 | 20 | 97 | 优秀 |
| 黄十三 | 32岁 | 男 | 身体健康，无不良嗜好 | 60 | 20 | 20 | 100 | 优秀 |
| 郑十 | 35岁 | 女 | 身体健康，无慢性疾病 | 60 | 16 | 20 | 96 | 优秀 |
| 张三 | 45岁 | 男 | 高血压，血压控制良好 | 60 | 10 | 0 | 70 | 基本 |

---

## 8. 算法局限性与改进方向

### 8.1 当前局限性

1. **关键词匹配简单**
   - 仅支持精确匹配，不支持同义词
   - 无法理解复杂的医学术语关系

2. **权重固定**
   - 年龄和健康状况的权重固定（各20分）
   - 无法根据试验类型动态调整

3. **缺少历史数据**
   - 未考虑受试者的历史参与记录
   - 未考虑依从性等软性指标

4. **二值化性别**
   - 仅支持男/女二元性别
   - 未考虑特殊情况

### 8.2 未来改进方向

1. **引入机器学习**
   - 使用历史数据训练模型
   - 自动学习最优权重配置

2. **语义理解增强**
   - 使用NLP技术理解医学术语
   - 支持同义词和相关概念匹配

3. **动态权重调整**
   - 根据试验类型自动调整评分权重
   - 支持自定义评分规则

4. **多因素扩展**
   - 增加地理位置、依从性等因素
   - 考虑受试者的历史参与记录

5. **个性化推荐**
   - 为不同研究人员提供个性化推荐
   - 学习研究人员的偏好

---

## 9. 技术实现细节

### 9.1 核心代码结构

```
MatchingServiceImpl
├── calculateMatchingScore()        // 主评分方法
├── calculateAgeScore()             // 年龄评分
├── calculateHealthMatchScore()     // 健康状况评分
├── normalizeGender()               // 性别标准化
├── generateMatchingExplanation()   // 生成说明
└── batchCalculateMatching()        // 批量处理
```

### 9.2 数据流

```
临床试验 + 受试者列表
    ↓
批量匹配处理
    ↓
逐个计算匹配分数
    ├── 硬性条件检查
    ├── 基础分（60分）
    ├── 年龄优先级分（0-20分）
    └── 健康状况分（0-20分）
    ↓
生成匹配说明
    ↓
按分数降序排序
    ↓
返回匹配结果列表
```

### 9.3 性能考虑

- **时间复杂度**：O(n)，n为受试者数量
- **空间复杂度**：O(n)，存储所有匹配结果
- **优化策略**：
  - 提前过滤不活跃的受试者
  - 使用并行流处理大量数据（可选）
  - 缓存常用的匹配结果

---

## 10. 总结

本智能匹配算法采用基于规则的多维度评分方法，综合考虑年龄、性别、健康状况等因素，为临床试验自动筛选和推荐最合适的受试者。算法具有以下特点：

✅ **准确性高**：硬性条件确保基本要求得到满足  
✅ **可解释性强**：每个评分维度都有明确的计算逻辑  
✅ **灵活性好**：适用于不同类型的临床试验  
✅ **易于维护**：代码结构清晰，便于扩展和优化  

该算法已成功应用于临床试验受试者智能匹配系统，显著提高了招募效率和匹配准确度。

---

## 附录

### A. 相关类和接口

- **MatchingService**：匹配服务接口
- **MatchingServiceImpl**：匹配服务实现类
- **MatchingResult**：匹配结果DTO
- **ClinicalTrial**：临床试验实体
- **User**：用户/受试者实体

### B. 配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 基础分 | 60 | 满足硬性条件的基础分数 |
| 年龄权重 | 20 | 年龄优先级最高分 |
| 健康权重 | 20 | 健康状况匹配最高分 |
| 优秀匹配阈值 | 90 | 优秀匹配的最低分数 |
| 良好匹配阈值 | 75 | 良好匹配的最低分数 |
| 基本匹配阈值 | 60 | 基本匹配的最低分数 |

### C. 版本历史

- **v1.0**（2026-01）：初始版本，实现基础匹配算法
- 未来版本：计划引入机器学习和语义理解

---

**文档版本**：v1.0  
**最后更新**：2026年1月13日  
**作者**：临床试验受试者智能匹配系统开发团队
